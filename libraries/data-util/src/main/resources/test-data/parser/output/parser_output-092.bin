
tika-input-doc-102*ðësource-code/PipelineConfigService_v4.java source-code/PipelineConfigService_v4.java//Â VARIATIONÂ 102Â ofÂ ServiceÂ ImplementationÂ (VariantÂ 4) //Â GeneratedÂ on:Â 2025-06-18T14:38:08.492667804Z //Â BaseÂ file:Â source-code/PipelineConfigService.java packageÂ com.rokkon.search.config.pipeline.service; importÂ com.fasterxml.jackson.core.JsonProcessingException; importÂ com.fasterxml.jackson.databind.JsonNode; importÂ com.fasterxml.jackson.databind.ObjectMapper; importÂ com.fasterxml.jackson.databind.node.ObjectNode; importÂ com.rokkon.search.config.pipeline.model.*; importÂ com.rokkon.search.config.pipeline.service.events.ConfigChangeEvent; importÂ com.rokkon.search.config.pipeline.service.validation.ValidationResult; importÂ io.quarkus.runtime.annotations.RegisterForReflection; importÂ org.slf4j.Logger; importÂ org.slf4j.LoggerFactory; importÂ jakarta.enterprise.context.ApplicationScoped; importÂ jakarta.enterprise.event.Event; importÂ jakarta.inject.Inject; importÂ java.net.URI; importÂ java.net.http.HttpClient; importÂ java.net.http.HttpRequest; importÂ java.net.http.HttpResponse; importÂ java.nio.charset.StandardCharsets; importÂ java.security.MessageDigest; importÂ java.security.NoSuchAlgorithmException; importÂ java.time.Duration; importÂ java.util.*; importÂ java.util.concurrent.CompletableFuture; importÂ java.util.concurrent.CompletionStage; /** Â *Â MainÂ serviceÂ forÂ CRUDÂ operationsÂ onÂ pipelineÂ configurations. Â *Â ImplementsÂ per-pipelineÂ storageÂ inÂ ConsulÂ withÂ comprehensiveÂ validation. Â */ @ApplicationScoped @RegisterForReflection publicÂ classÂ PipelineConfigServiceÂ { Â Â Â Â  Â Â Â Â privateÂ staticÂ finalÂ LoggerÂ LOGÂ =Â LoggerFactory.getLogger(PipelineConfigService.class); Â Â Â Â  Â Â Â Â privateÂ finalÂ ObjectMapperÂ objectMapper; Â Â Â Â privateÂ finalÂ ConfigValidationServiceÂ validationService; Â Â Â Â privateÂ finalÂ SchemaValidationServiceÂ schemaValidationService; Â Â Â Â privateÂ finalÂ Event<ConfigChangeEvent>Â configChangeEvent; Â Â Â Â privateÂ finalÂ HttpClientÂ httpClient; Â Â Â Â  Â Â Â Â //Â ConsulÂ configuration Â Â Â Â privateÂ finalÂ StringÂ consulHost; Â Â Â Â privateÂ finalÂ StringÂ consulPort; Â Â Â Â privateÂ finalÂ StringÂ consulBaseUrl; Â Â Â Â  Â Â Â Â @Inject Â Â Â Â publicÂ PipelineConfigService( Â Â Â Â Â Â Â Â Â Â Â Â ObjectMapperÂ objectMapper, Â Â Â Â Â Â Â Â Â Â Â Â ConfigValidationServiceÂ validationService, Â Â Â Â Â Â Â Â Â Â Â Â SchemaValidationServiceÂ schemaValidationService, Â Â Â Â Â Â Â Â Â Â Â Â Event<ConfigChangeEvent>Â configChangeEvent, Â Â Â Â Â Â Â Â Â Â Â Â @org.eclipse.microprofile.config.inject.ConfigProperty(nameÂ =Â "quarkus.consul-config.agent.host-port")Â  Â Â Â Â Â Â Â Â Â Â Â Â Optional<String>Â consulConfig)Â { Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â this.objectMapperÂ =Â objectMapper; Â Â Â Â Â Â Â Â this.validationServiceÂ =Â validationService; Â Â Â Â Â Â Â Â this.schemaValidationServiceÂ =Â schemaValidationService; Â Â Â Â Â Â Â Â this.configChangeEventÂ =Â configChangeEvent; Â Â Â Â Â Â Â Â this.httpClientÂ =Â HttpClient.newBuilder() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .connectTimeout(Duration.ofSeconds(10)) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .build(); Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â //Â ParseÂ ConsulÂ configuration Â Â Â Â Â Â Â Â ifÂ (consulConfig.isPresent())Â { Â Â Â Â Â Â Â Â Â Â Â Â String[]Â hostPortÂ =Â consulConfig.get().split(":"); Â Â Â Â Â Â Â Â Â Â Â Â this.consulHostÂ =Â hostPort[0]; Â Â Â Â Â Â Â Â Â Â Â Â this.consulPortÂ =Â hostPort.lengthÂ >Â 1Â ?Â hostPort[1]Â :Â "8500"; Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â this.consulHostÂ =Â "localhost"; Â Â Â Â Â Â Â Â Â Â Â Â this.consulPortÂ =Â "8500"; Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â this.consulBaseUrlÂ =Â "http://"Â +Â consulHostÂ +Â ":"Â +Â consulPort; Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â LOG.info("PipelineConfigServiceÂ initializedÂ withÂ ConsulÂ at:Â {}",Â consulBaseUrl); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â CreatesÂ aÂ newÂ pipelineÂ inÂ theÂ specifiedÂ cluster. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<ValidationResult>Â createPipeline(StringÂ clusterName,Â StringÂ pipelineId,Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ config,Â StringÂ initiatedBy)Â { Â Â Â Â Â Â Â Â LOG.info("CreatingÂ pipelineÂ '{}'Â inÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ validatePipelineForCreation(clusterName,Â pipelineId,Â config) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenCompose(validationResultÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!validationResult.valid())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture(validationResult); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ storePipelineInConsul(clusterName,Â pipelineId,Â config) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenApply(successÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (success)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â FireÂ creationÂ event Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â configChangeEvent.fire(ConfigChangeEvent.pipelineCreated( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clusterName,Â pipelineId,Â config,Â initiatedBy)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.info("SuccessfullyÂ createdÂ pipelineÂ '{}'Â inÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.success(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.failure("FailedÂ toÂ storeÂ pipelineÂ inÂ Consul"); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â UpdatesÂ anÂ existingÂ pipeline. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<ValidationResult>Â updatePipeline(StringÂ clusterName,Â StringÂ pipelineId, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ newConfig,Â StringÂ initiatedBy)Â { Â Â Â Â Â Â Â Â LOG.info("UpdatingÂ pipelineÂ '{}'Â inÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ getPipeline(clusterName,Â pipelineId) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenCompose(oldConfigÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (oldConfig.isEmpty())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ValidationResult.failure("PipelineÂ '"Â +Â pipelineIdÂ +Â "'Â notÂ found")); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ validatePipelineForUpdate(clusterName,Â pipelineId,Â newConfig,Â oldConfig.get()) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenCompose(validationResultÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!validationResult.valid())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture(validationResult); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ storePipelineInConsul(clusterName,Â pipelineId,Â newConfig) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenApply(successÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (success)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â FireÂ updateÂ event Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â configChangeEvent.fire(ConfigChangeEvent.pipelineUpdated( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clusterName,Â pipelineId,Â newConfig,Â oldConfig.get(),Â initiatedBy)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.info("SuccessfullyÂ updatedÂ pipelineÂ '{}'Â inÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.success(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.failure("FailedÂ toÂ updateÂ pipelineÂ inÂ Consul"); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â DeletesÂ aÂ pipeline. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<ValidationResult>Â deletePipeline(StringÂ clusterName,Â StringÂ pipelineId,Â StringÂ initiatedBy)Â { Â Â Â Â Â Â Â Â LOG.info("DeletingÂ pipelineÂ '{}'Â fromÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ getPipeline(clusterName,Â pipelineId) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenCompose(oldConfigÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (oldConfig.isEmpty())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ValidationResult.failure("PipelineÂ '"Â +Â pipelineIdÂ +Â "'Â notÂ found")); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ deletePipelineFromConsul(clusterName,Â pipelineId) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenApply(successÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (success)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â FireÂ deletionÂ event Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â configChangeEvent.fire(ConfigChangeEvent.pipelineDeleted( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clusterName,Â pipelineId,Â oldConfig.get(),Â initiatedBy)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.info("SuccessfullyÂ deletedÂ pipelineÂ '{}'Â fromÂ clusterÂ '{}'",Â pipelineId,Â clusterName); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.success(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ ValidationResult.failure("FailedÂ toÂ deleteÂ pipelineÂ fromÂ Consul"); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â GetsÂ aÂ pipelineÂ configuration. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<Optional<PipelineConfig>>Â getPipeline(StringÂ clusterName,Â StringÂ pipelineId)Â { Â Â Â Â Â Â Â Â returnÂ retrievePipelineFromConsul(clusterName,Â pipelineId); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â ListsÂ allÂ pipelinesÂ inÂ aÂ cluster. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<Map<String,Â PipelineConfig>>Â listPipelines(StringÂ clusterName)Â { Â Â Â Â Â Â Â Â returnÂ listPipelinesFromConsul(clusterName); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â AnalyzesÂ theÂ impactÂ ofÂ deletingÂ aÂ pipelineÂ orÂ module. Â Â Â Â Â */ Â Â Â Â publicÂ CompletionStage<DependencyImpactAnalysis>Â analyzeDeletionImpact(StringÂ clusterName,Â StringÂ targetId,Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â DependencyTypeÂ targetType)Â { Â Â Â Â Â Â Â Â LOG.info("AnalyzingÂ deletionÂ impactÂ forÂ {}Â '{}'Â inÂ clusterÂ '{}'",Â targetType,Â targetId,Â clusterName); Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ listPipelines(clusterName) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenApply(pipelinesÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â affectedPipelinesÂ =Â newÂ ArrayList<>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â orphanedTopicsÂ =Â newÂ ArrayList<>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â orphanedServicesÂ =Â newÂ ArrayList<>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ (varÂ entryÂ :Â pipelines.entrySet())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ pipelineIdÂ =Â entry.getKey(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ pipelineÂ =Â entry.getValue(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (targetTypeÂ ==Â DependencyType.PIPELINEÂ &&Â targetId.equals(pipelineId))Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â continue;Â //Â SkipÂ theÂ targetÂ pipelineÂ itself Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â booleanÂ isAffectedÂ =Â checkPipelineAffectedByDeletion(pipeline,Â targetId,Â targetType); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (isAffected)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â affectedPipelines.add(pipelineId); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ newÂ DependencyImpactAnalysis( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â targetId, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â targetType, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â affectedPipelines, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â orphanedTopics, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â orphanedServices, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â affectedPipelines.isEmpty() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â CanonicalizesÂ JSONÂ forÂ consistentÂ orderingÂ andÂ hashing. Â Â Â Â Â *Â BasedÂ onÂ theÂ patternÂ fromÂ theÂ oldÂ ConsulModuleRegistrationService. Â Â Â Â Â */ Â Â Â Â publicÂ StringÂ canonicalizeJson(StringÂ jsonString)Â throwsÂ JsonProcessingExceptionÂ { Â Â Â Â Â Â Â Â JsonNodeÂ nodeÂ =Â objectMapper.readTree(jsonString); Â Â Â Â Â Â Â Â returnÂ canonicalizeJsonNode(node); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ StringÂ canonicalizeJsonNode(JsonNodeÂ node)Â throwsÂ JsonProcessingExceptionÂ { Â Â Â Â Â Â Â Â ifÂ (node.isObject())Â { Â Â Â Â Â Â Â Â Â Â Â Â ObjectNodeÂ sortedNodeÂ =Â objectMapper.createObjectNode(); Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â fieldNamesÂ =Â newÂ ArrayList<>(); Â Â Â Â Â Â Â Â Â Â Â Â node.fieldNames().forEachRemaining(fieldNames::add); Â Â Â Â Â Â Â Â Â Â Â Â Collections.sort(fieldNames); Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â forÂ (StringÂ fieldNameÂ :Â fieldNames)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â JsonNodeÂ childNodeÂ =Â node.get(fieldName); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (childNode.isObject()Â ||Â childNode.isArray())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sortedNode.set(fieldName,Â objectMapper.readTree(canonicalizeJsonNode(childNode))); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sortedNode.set(fieldName,Â childNode); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â returnÂ objectMapper.writeValueAsString(sortedNode); Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ objectMapper.writeValueAsString(node); Â Â Â Â } Â Â Â Â  Â Â Â Â /** Â Â Â Â Â *Â GeneratesÂ anÂ MD5Â digestÂ forÂ configurationÂ versioning. Â Â Â Â Â */ Â Â Â Â publicÂ StringÂ generateConfigDigest(StringÂ configJson)Â throwsÂ NoSuchAlgorithmExceptionÂ { Â Â Â Â Â Â Â Â MessageDigestÂ mdÂ =Â MessageDigest.getInstance("MD5"); Â Â Â Â Â Â Â Â byte[]Â digestÂ =Â md.digest(configJson.getBytes(StandardCharsets.UTF_8)); Â Â Â Â Â Â Â Â returnÂ Base64.getEncoder().encodeToString(digest); Â Â Â Â } Â Â Â Â  Â Â Â Â //Â PrivateÂ helperÂ methods Â Â Â Â  Â Â Â Â privateÂ CompletionStage<ValidationResult>Â validatePipelineForCreation(StringÂ clusterName,Â StringÂ pipelineId,Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ config)Â { Â Â Â Â Â Â Â Â returnÂ validationService.validatePipelineStructure(pipelineId,Â config) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenCompose(structuralResultÂ ->Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!structuralResult.valid())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture(structuralResult); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â JSONÂ SchemaÂ validation Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â tryÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ configJsonÂ =Â objectMapper.writeValueAsString(config); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ schemaValidationService.validatePipelineStepConfig(configJson) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .thenApply(schemaResultÂ ->Â structuralResult.combine(schemaResult)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â catchÂ (JsonProcessingExceptionÂ e)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ CompletableFuture.completedFuture( Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ValidationResult.failure("FailedÂ toÂ serializeÂ pipelineÂ config:Â "Â +Â e.getMessage())); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ CompletionStage<ValidationResult>Â validatePipelineForUpdate(StringÂ clusterName,Â StringÂ pipelineId, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ newConfig,Â PipelineConfigÂ oldConfig)Â { Â Â Â Â Â Â Â Â //Â SameÂ validationÂ asÂ creationÂ forÂ now,Â butÂ couldÂ addÂ update-specificÂ checks Â Â Â Â Â Â Â Â returnÂ validatePipelineForCreation(clusterName,Â pipelineId,Â newConfig); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ CompletionStage<Boolean>Â storePipelineInConsul(StringÂ clusterName,Â StringÂ pipelineId,Â PipelineConfigÂ config)Â { Â Â Â Â Â Â Â Â returnÂ CompletableFuture.supplyAsync(()Â ->Â { Â Â Â Â Â Â Â Â Â Â Â Â tryÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ configJsonÂ =Â canonicalizeJson(objectMapper.writeValueAsString(config)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ consulKeyÂ =Â buildPipelineKey(clusterName,Â pipelineId); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpRequestÂ requestÂ =Â HttpRequest.newBuilder() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uri(URI.create(consulBaseUrlÂ +Â "/v1/kv/"Â +Â consulKey)) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .PUT(HttpRequest.BodyPublishers.ofString(configJson)) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .build(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpResponse<String>Â responseÂ =Â httpClient.send(request,Â HttpResponse.BodyHandlers.ofString()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â booleanÂ successÂ =Â response.statusCode()Â ==Â 200; Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (success)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.debug("StoredÂ pipelineÂ '{}'Â inÂ ConsulÂ atÂ keyÂ '{}'",Â pipelineId,Â consulKey); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("FailedÂ toÂ storeÂ pipelineÂ '{}'Â inÂ Consul.Â Status:Â {},Â Body:Â {}",Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â pipelineId,Â response.statusCode(),Â response.body()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ success; Â Â Â Â Â Â Â Â Â Â Â Â }Â catchÂ (ExceptionÂ e)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("ErrorÂ storingÂ pipelineÂ '{}'Â inÂ Consul:Â {}",Â pipelineId,Â e.getMessage(),Â e); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ false; Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ CompletionStage<Optional<PipelineConfig>>Â retrievePipelineFromConsul(StringÂ clusterName,Â StringÂ pipelineId)Â { Â Â Â Â Â Â Â Â returnÂ CompletableFuture.supplyAsync(()Â ->Â { Â Â Â Â Â Â Â Â Â Â Â Â tryÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ consulKeyÂ =Â buildPipelineKey(clusterName,Â pipelineId); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpRequestÂ requestÂ =Â HttpRequest.newBuilder() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uri(URI.create(consulBaseUrlÂ +Â "/v1/kv/"Â +Â consulKeyÂ +Â "?raw")) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .GET() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .build(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpResponse<String>Â responseÂ =Â httpClient.send(request,Â HttpResponse.BodyHandlers.ofString()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (response.statusCode()Â ==Â 200)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PipelineConfigÂ configÂ =Â objectMapper.readValue(response.body(),Â PipelineConfig.class); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ Optional.of(config); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (response.statusCode()Â ==Â 404)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ Optional.<PipelineConfig>empty(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("FailedÂ toÂ retrieveÂ pipelineÂ '{}'Â fromÂ Consul.Â Status:Â {}",Â pipelineId,Â response.statusCode()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ Optional.<PipelineConfig>empty(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â }Â catchÂ (ExceptionÂ e)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("ErrorÂ retrievingÂ pipelineÂ '{}'Â fromÂ Consul:Â {}",Â pipelineId,Â e.getMessage(),Â e); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ Optional.<PipelineConfig>empty(); Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ CompletionStage<Boolean>Â deletePipelineFromConsul(StringÂ clusterName,Â StringÂ pipelineId)Â { Â Â Â Â Â Â Â Â returnÂ CompletableFuture.supplyAsync(()Â ->Â { Â Â Â Â Â Â Â Â Â Â Â Â tryÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ consulKeyÂ =Â buildPipelineKey(clusterName,Â pipelineId); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpRequestÂ requestÂ =Â HttpRequest.newBuilder() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uri(URI.create(consulBaseUrlÂ +Â "/v1/kv/"Â +Â consulKey)) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .DELETE() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .build(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpResponse<String>Â responseÂ =Â httpClient.send(request,Â HttpResponse.BodyHandlers.ofString()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â booleanÂ successÂ =Â response.statusCode()Â ==Â 200; Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (success)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.debug("DeletedÂ pipelineÂ '{}'Â fromÂ ConsulÂ atÂ keyÂ '{}'",Â pipelineId,Â consulKey); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("FailedÂ toÂ deleteÂ pipelineÂ '{}'Â fromÂ Consul.Â Status:Â {}",Â pipelineId,Â response.statusCode()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ success; Â Â Â Â Â Â Â Â Â Â Â Â }Â catchÂ (ExceptionÂ e)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("ErrorÂ deletingÂ pipelineÂ '{}'Â fromÂ Consul:Â {}",Â pipelineId,Â e.getMessage(),Â e); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ false; Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ CompletionStage<Map<String,Â PipelineConfig>>Â listPipelinesFromConsul(StringÂ clusterName)Â { Â Â Â Â Â Â Â Â returnÂ CompletableFuture.supplyAsync(()Â ->Â { Â Â Â Â Â Â Â Â Â Â Â Â tryÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ consulPrefixÂ =Â buildClusterPrefix(clusterName)Â +Â "pipelines/"; Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpRequestÂ requestÂ =Â HttpRequest.newBuilder() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uri(URI.create(consulBaseUrlÂ +Â "/v1/kv/"Â +Â consulPrefixÂ +Â "?keys")) Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .GET() Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .build(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HttpResponse<String>Â responseÂ =Â httpClient.send(request,Â HttpResponse.BodyHandlers.ofString()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (response.statusCode()Â ==Â 200)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â String[]Â keysÂ =Â objectMapper.readValue(response.body(),Â String[].class); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Map<String,Â PipelineConfig>Â pipelinesÂ =Â newÂ HashMap<>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ (StringÂ keyÂ :Â keys)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â StringÂ pipelineIdÂ =Â extractPipelineIdFromKey(key); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (pipelineIdÂ !=Â null)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Optional<PipelineConfig>Â configÂ =Â retrievePipelineFromConsul(clusterName,Â pipelineId).toCompletableFuture().join(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â config.ifPresent(cÂ ->Â pipelines.put(pipelineId,Â c)); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ pipelines; Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (response.statusCode()Â ==Â 404)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ newÂ HashMap<String,Â PipelineConfig>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("FailedÂ toÂ listÂ pipelinesÂ fromÂ Consul.Â Status:Â {}",Â response.statusCode()); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ newÂ HashMap<String,Â PipelineConfig>(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â }Â catchÂ (ExceptionÂ e)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOG.error("ErrorÂ listingÂ pipelinesÂ fromÂ Consul:Â {}",Â e.getMessage(),Â e); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ newÂ HashMap<String,Â PipelineConfig>(); Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â }); Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ booleanÂ checkPipelineAffectedByDeletion(PipelineConfigÂ pipeline,Â StringÂ targetId,Â DependencyTypeÂ targetType)Â { Â Â Â Â Â Â Â Â ifÂ (pipeline.pipelineSteps()Â ==Â null)Â { Â Â Â Â Â Â Â Â Â Â Â Â returnÂ false; Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â forÂ (PipelineStepConfigÂ stepÂ :Â pipeline.pipelineSteps().values())Â { Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (targetTypeÂ ==Â DependencyType.MODULEÂ &&Â step.processorInfo()Â !=Â nullÂ &&Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â targetId.equals(step.processorInfo().grpcServiceName()))Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ true; Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (step.outputs()Â !=Â null)Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ (varÂ outputÂ :Â step.outputs().values())Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (output.grpcTransport()Â !=Â nullÂ &&Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â targetId.equals(output.grpcTransport().serviceName()))Â { Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ true; Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â returnÂ false; Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ StringÂ buildPipelineKey(StringÂ clusterName,Â StringÂ pipelineId)Â { Â Â Â Â Â Â Â Â returnÂ buildClusterPrefix(clusterName)Â +Â "pipelines/"Â +Â pipelineIdÂ +Â "/config"; Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ StringÂ buildClusterPrefix(StringÂ clusterName)Â { Â Â Â Â Â Â Â Â returnÂ "rokkon-clusters/"Â +Â clusterNameÂ +Â "/"; Â Â Â Â } Â Â Â Â  Â Â Â Â privateÂ StringÂ extractPipelineIdFromKey(StringÂ key)Â { Â Â Â Â Â Â Â Â //Â ExtractÂ from:Â rokkon-clusters/{cluster}/pipelines/{pipelineId}/config Â Â Â Â Â Â Â Â String[]Â partsÂ =Â key.split("/"); Â Â Â Â Â Â Â Â ifÂ (parts.lengthÂ >=Â 4Â &&Â "pipelines".equals(parts[2]))Â { Â Â Â Â Â Â Â Â Â Â Â Â returnÂ parts[3]; Â Â Â Â Â Â Â Â } Â Â Â Â Â Â Â Â returnÂ null; Â Â Â Â } Â Â Â Â  Â Â Â Â //Â SupportingÂ classes Â Â Â Â  Â Â Â Â publicÂ recordÂ DependencyImpactAnalysis( Â Â Â Â Â Â Â Â Â Â Â Â StringÂ targetId, Â Â Â Â Â Â Â Â Â Â Â Â DependencyTypeÂ targetType, Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â affectedPipelines, Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â orphanedTopics, Â Â Â Â Â Â Â Â Â Â Â Â List<String>Â orphanedServices, Â Â Â Â Â Â Â Â Â Â Â Â booleanÂ canSafelyDelete Â Â Â Â )Â {} Â Â Â Â  Â Â Â Â publicÂ enumÂ DependencyTypeÂ { Â Â Â Â Â Â Â Â PIPELINE,Â MODULE,Â SCHEMA Â Â Â Â } } //Â ENDÂ VARIATIONÂ 102 //Â TotalÂ size:Â 22253Â charactersbÑ

loc479
6
x_tika_encodingdetectorUniversalEncodingDetector
q
x_tika_parsed_by_full_setTRorg.apache.tika.parser.DefaultParser; org.apache.tika.parser.code.SourceCodeParser
$
content_typetext/x-java-source
 
content_encoding
ISO-8859-1
'
x_tika_detectedencoding
ISO-8859-1
;
resourcename+)source-code/PipelineConfigService_v4.java
h
x_tika_parsed_byTRorg.apache.tika.parser.DefaultParser; org.apache.tika.parser.code.SourceCodeParser